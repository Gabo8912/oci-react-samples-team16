version: 0.1
component: build
timeoutInSeconds: 3600
shell: bash

env:
  variables:
    user_ocir: ${user_ocir}
    auth_token_ocir: ${auth_token_ocir}
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: ax4igplyyag4
    REPO: oracle-bot-repository-team16

  exportedVariables:
    - IMAGE_TAG

steps:
  - type: Command
    name: "DEBUG cat build_spec.yaml"
    timeoutInSeconds: 60
    command: |
      echo "------ mostrando build_spec.yaml que est√° cargando el runner ------"
      cat ${OCI_PRIMARY_SOURCE_DIR}/build_spec.yaml
      echo "-------------------------------------------------------------"

  - type: Command
    name: "Define unique image tag"
    timeoutInSeconds: 140
    command: |
      echo "OCI_BUILD_RUN_ID: ${OCI_BUILD_RUN_ID}"
      export IMAGE_TAG=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      echo "IMAGE_TAG=${IMAGE_TAG}"

  - type: Command
    name: "DEBUG print user_ocir"
    timeoutInSeconds: 60
    command: |
      echo "|${user_ocir}|"
      echo "length=${#user_ocir}"

  - type: Command
    name: "Login to OCIR"
    timeoutInSeconds: 140
    command: |
      echo "${auth_token_ocir}" \
        | docker login "${REGISTRY}" -u "${user_ocir}" --password-stdin

  - type: Command
    name: "Build & Push Docker Image"
    timeoutInSeconds: 300
    command: |
      cd MtdrSpring/backend
      docker build -t "${REGISTRY}/${NAMESPACE}/${REPO}:${IMAGE_TAG}" .
      docker push "${REGISTRY}/${NAMESPACE}/${REPO}:${IMAGE_TAG}"

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: "${REGISTRY}/${NAMESPACE}/${REPO}:${IMAGE_TAG}"
