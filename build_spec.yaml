version: 0.1
component: build
timeoutInSeconds: 3600
shell: bash

env:
  variables:
    # Variables que se definen como parÃ¡metros en OCI DevOps
    auth_token_ocir: ${auth_token_ocir}
    user_ocir: ${user_ocir}

    # ConfiguraciÃ³n del registry
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: ax4igplyyag4
    REPO: oracle-bot-repository-team16

  exportedVariables:
    - IMAGE_TAG

steps:
  - type: Command
    name: Set Image Tag
    command: |
      echo "ðŸ”§ Definiendo tag de imagen a partir del OCI_BUILD_RUN_ID..."
      export IMAGE_TAG=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      echo "IMAGE_TAG=$IMAGE_TAG"

  - type: Command
    name: Login to OCIR
    command: |
      echo "ðŸ”‘ Autenticando en OCIR..."
      echo "${auth_token_ocir}" \
        | docker login $REGISTRY \
            -u "${user_ocir}" \
            --password-stdin

  - type: Command
    name: Build & Push Docker Image
    command: |
      echo "ðŸš€ Construyendo imagen y subiÃ©ndola a OCIR con tag ${IMAGE_TAG}..."
      cd MtdrSpring/backend

      docker build -f Dockerfile -t $REGISTRY/$NAMESPACE/$REPO:$IMAGE_TAG .
      docker push $REGISTRY/$NAMESPACE/$REPO:$IMAGE_TAG

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: ${REGISTRY}/${NAMESPACE}/${REPO}:${IMAGE_TAG}
