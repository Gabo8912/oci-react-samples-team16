version: 0.1
component: build
timeoutInSeconds: 3600
shell: bash

env:
  variables:
    # Tus par치metros configurados en la UI del Build Pipeline
    user_ocir: ${user_ocir}
    auth_token_ocir: ${auth_token_ocir}

    # Valores fijos de tu OCIR
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: ax4igplyyag4
    REPO: oracle-bot-repository-team16

    # Si alguna vez quieres forzar un tag distinto al autom치tico,
    # puedes pasar image_tag como par치metro. Si no, lo generamos abajo:
    IMAGE_TAG: ${image_tag}

steps:
  - type: Command
    name: Define unique image tag
    command: |
      # Si no vienen image_tag como par치metro, lo creamos a partir del build run ID
      if [ -z "$IMAGE_TAG" ]; then
        export IMAGE_TAG=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      fi
      echo "Using IMAGE_TAG=$IMAGE_TAG"
      echo "IMAGE_TAG=$IMAGE_TAG" >> $OCI_OUTPUT_DIR/build_vars

  - type: Command
    name: Login to OCIR
    command: |
      echo "${auth_token_ocir}" \
        | docker login "${REGISTRY}" -u "${user_ocir}" --password-stdin

  - type: Command
    name: Build & Push Docker Image
    command: |
      cd MtdrSpring/backend
      docker build -t "${REGISTRY}/${NAMESPACE}/${REPO}:${IMAGE_TAG}" .
      docker push "${REGISTRY}/${NAMESPACE}/${REPO}:${IMAGE_TAG}"

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: "${REGISTRY}/${NAMESPACE}/${REPO}:${IMAGE_TAG}"
