version: 0.1
component: build
timeoutInSeconds: 3600
shell: bash

env:
  variables:
    # Credenciales de Docker Hub (se configuran como par√°metros en el pipeline)
    DOCKERHUB_USER: ${DOCKERHUB_USER}
    DOCKERHUB_TOKEN: ${DOCKERHUB_TOKEN}

    # Tus valores actuales
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: ax4igplyyag4
    REPO: oracle-bot-repository-team16

  exportedVariables:
    - BUILDRUN_HASH
    - IMAGE_TAG

steps:
  - type: Command
    name: Define unique tag
    command: |
      echo "OCI_BUILD_RUN_ID: ${OCI_BUILD_RUN_ID}"
      export BUILDRUN_HASH=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      export IMAGE_TAG=$BUILDRUN_HASH
      echo "BUILDRUN_HASH=$BUILDRUN_HASH"
      echo "IMAGE_TAG=$IMAGE_TAG"

  - type: Command
    name: Login to Docker Hub
    command: |
      echo "${DOCKERHUB_TOKEN}" \
        | docker login docker.io -u "${DOCKERHUB_USER}" --password-stdin

  - type: Command
    name: Login to OCIR
    command: |
      echo "${auth_token_ocir}" \
        | docker login $REGISTRY -u "${user_ocir}" --password-stdin

  - type: Command
    name: Build & Push
    command: |
      cd MtdrSpring/backend
      docker build -t $REGISTRY/$NAMESPACE/$REPO:$IMAGE_TAG .
      docker push $REGISTRY/$NAMESPACE/$REPO:$IMAGE_TAG

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: ${REGISTRY}/${NAMESPACE}/${REPO}:${IMAGE_TAG}
